<video id="vid1" autoplay muted></video>
<video id="vid2" autoplay></video>

<br>
<p id="inst"></p>
<textarea id="area"></textarea>
<button id="button">Continue</button>
<button id="create">Create room</button>
<button id="join">Join room</button>

<script>
var vid1 = document.querySelector("#vid1");
var vid2 = document.querySelector("#vid2");
var inst = document.querySelector("#inst");
var area = document.querySelector("#area");
var button = document.querySelector("#button");
var createBtn = document.querySelector("#create");
var joinBtn = document.querySelector("#join");

createBtn.onclick = create;
joinBtn.onclick = join;

var servers = {iceServers:[{urls:'stun:stun1.l.google.com:19302', url: 'stun:stun1.l.google.com:19302'}]};

function logError(err){
	alert(err.name + ": " + err.message);
}

function create(){
	createBtn.style.display = 'none';
	joinBtn.style.display = 'none';
	
	var pc = new webkitRTCPeerConnection(servers);
	
	pc.onicecandidate = function(evt){
		console.log(evt);
		if(!evt.candidate){
			pc.onicecandidate = null;
			inst.innerText = "Send this to the other person and then click continue.";
			area.value = JSON.stringify(pc.localDescription);
			button.onclick = receiveAnswer;
		}
	};
	
	function receiveAnswer(){
		inst.innerText = "Paste answer received from other person then click continue.";
		area.value = "";
		button.onclick = processAnswer;
	}
	
	function processAnswer(){
		area.style.display = 'none';
		button.style.display = 'none';
		inst.innerText = "Now just wait until you connect.  To end the call, close this tab.";
		
		var offer = new RTCSessionDescription(JSON.parse(area.value));
		area.value = "";
		
		pc.setRemoteDescription(offer, function(){}, logError);
	}
	
	function createLocalOffer(){
		pc.createOffer(function(desc){
			console.log(desc);
			pc.setLocalDescription(desc, function(){}, logError);
		}, logError)
	}
	
	function setupDataConnection(){
		var dc = pc.createDataChannel("test", {reliable: true});
		
		dc.onopen = function(){
			next(true, dc);
		};
		
		dc.onerror = logError;
		
		console.log(dc.onopen);
	}
	
	inst.innerText = "Processing...";
	
	setupDataConnection();
	createLocalOffer();
}

function join(){
	createBtn.style.display = 'none';
	joinBtn.style.display = 'none';
	
	var pc = new webkitRTCPeerConnection(servers);
	
	pc.onicecandidate = function(evt){
		console.log(evt);
		if(!evt.candidate){
			pc.onicecandidate = null;
			inst.innerText = "Now send this to the other person and click continue.";
			area.value = JSON.stringify(pc.localDescription);
			button.onclick = answerSent;
		}
	};
	
	pc.ondatachannel = function(evt){
		var dc = evt.channel;
		
		dc.onopen = function(){
			next(false, dc);
		};
		
		dc.onerror = logError;
	};
	
	function answerSent(){
		area.style.display = 'none';
		button.style.display = 'none';
		inst.innerText = "Now just wait until you connect.  To end the call, close this tab.";
	}
	
	function acceptOffer(){
		inst.innerText = "Paste the offer the other person sent you into the textbox and click continue.";
		button.onclick = processOffer;
	}
	
	function processOffer(){
		inst.innerText = "Processing...";
		var offer = new RTCSessionDescription(JSON.parse(area.value));
		area.value = "";
		
		pc.setRemoteDescription(offer, function(){}, logError);
		pc.createAnswer(function(desc){
			console.log(desc);
			pc.setLocalDescription(desc, function(){}, logError);
		}, logError);
	}
		
	acceptOffer();
}

function next(creater, dc){
	console.log("next " + creater);

	var pc;
	
	// call start() to initiate
	
	function start() {
		pc = new webkitRTCPeerConnection(servers);
		
		// send any ice candidates to the other peer
		pc.onicecandidate = function (evt) {
			if (evt.candidate)
				dc.send(JSON.stringify({
					'candidate': evt.candidate
				}));
		};
		
		// let the 'negotiationneeded' event trigger offer generation
		pc.onnegotiationneeded = function () {
			pc.createOffer(localDescCreated, logError);
		}
		
		// once remote stream arrives, show it in the remote video element
		pc.onaddstream = function (evt) {
			vid2.src = URL.createObjectURL(evt.stream);
		};
	
		// get a local stream, show it in a self-view and add it to be sent
		navigator.webkitGetUserMedia({
			'audio': true,
			'video': true
		}, function (stream) {
			vid1.src = URL.createObjectURL(stream);
			pc.addStream(stream);
		}, logError);
	}

	function localDescCreated(desc) {
		pc.setLocalDescription(desc, function () {
			dc.send(JSON.stringify({
				'sdp': pc.localDescription
			}));
		}, logError);
	}

	if(creater){ start(); }

	dc.onmessage = function (evt) {
		if (!pc)
			start();

		var message = JSON.parse(evt.data);
		if (message.sdp)
			pc.setRemoteDescription(new RTCSessionDescription(message.sdp), function () {
				// if we received an offer, we need to answer
				if (pc.remoteDescription.type == 'offer')
					pc.createAnswer(localDescCreated, logError);
			}, logError);
		else
			pc.addIceCandidate(new RTCIceCandidate(message.candidate));
	};
}

</script>
