<video id="vid1" autoplay muted></video>
<video id="vid2" autoplay></video>

<br>
<p id="inst"></p>
<textarea id="area"></textarea>
<button id="button">Continue</button>
<button id="create">Create room</button>
<button id="join">Join room</button>

<script>
var vid1 = document.querySelector("#vid1");
var vid2 = document.querySelector("#vid2");
var inst = document.querySelector("#inst");
var area = document.querySelector("#area");
var button = document.querySelector("#button");
var createBtn = document.querySelector("#create");
var joinBtn = document.querySelector("#join");

createBtn.onclick = create;
joinBtn.onclick = join;

var servers = {iceServers: [{url: 'stun:stun4.l.google.com:19302'}]};

var dc;

function create(){
	createBtn.style.display = 'none';
	joinBtn.style.display = 'none';
	
	var pc = new webkitRTCPeerConnection(servers);
	var candidates = [];
	
	pc.onicecandidate = function(evt){
		console.log(evt);
		if(evt.candidate){
			candidates.push(evt.candidate);
		}
	};
	
	pc.onaddstream = function(evt){
		vid2.src = URL.createObjectURL(evt.stream);
	};
	
	function receiveAnswer(){
		inst.innerText = "Paste answer received from other person then click continue.";
		area.value = "";
		button.onclick = processAnswer;
	}
	
	function processAnswer(){
		area.style.display = 'none';
		button.style.display = 'none';
		inst.innerText = "Now just wait until you connect.  To end the call, close this tab.";
		
		var desc = new RTCSessionDescription(JSON.parse(area.value));
		console.log(desc);
		pc.setRemoteDescription(desc);
	}
	
	function createLocalOffer(){
		pc.createOffer(function(desc){
			console.log(desc);
			pc.setLocalDescription(desc, function(){
				inst.innerText = "Send this to the other person and then click continue.";
				area.value = JSON.stringify(pc.localDescription);
				button.onclick = receiveAnswer;
			}, function(){});
		})
	}
	
	function setupDataChannel(){
		dc = pc.createDataChannel("test", {reliable: true});
		
		dc.onload = function(){
			for(var i in candidates){
				dc.send(JSON.stringify(candidates[i]));
			}
		};
		
		dc.onmessage = function(evt){
			var message = JSON.parse(evt.data);
			
			pc.addIceCandidate(new RTCIceCandidate(message));
		};
	}
	
	navigator.webkitGetUserMedia({video: true, audio: true}, function(stream){
		vid1.src = URL.createObjectURL(stream);
		pc.addStream(stream);
		
		setupDataChannel();
		createLocalOffer();
	}, function(){});
}

function join(){
	createBtn.style.display = 'none';
	joinBtn.style.display = 'none';
	
	var pc = new webkitRTCPeerConnection(servers);
	var candidates = [];
	
	pc.ondatachannel = function(evt){
		dc = evt.channel;
		
		dc.onload = function(){
			for(var i in candidates){
				dc.send(JSON.stringify(candidates[i]));
			}
		};
		
		dc.onmessage = function(evt){
			var message = JSON.parse(evt.data);
			
			pc.addIceCandidate(new RTCIceCandidate(message));
		};
	};
	
	pc.onicecandidate = function(evt){
		console.log(evt);
		if(evt.candidate){
			candidates.push(evt.candidate);
		}
	};
	
	pc.onaddstream = function(evt){
		vid2.src = URL.createObjectURL(evt.stream);
	};
	
	function answerSent(){
		area.style.display = 'none';
		button.style.display = 'none';
		inst.innerText = "Now just wait until you connect.  To end the call, close this tab.";
	}
	
	function acceptOffer(){
		inst.innerText = "Paste the offer the other person sent you into the textbox and click continue.";
		button.onclick = processOffer;
	}
	
	function processOffer(){
		inst.innerText = "Processing...";
		var offer = new RTCSessionDescription(JSON.parse(area.value));
		area.value = "";
		
		pc.setRemoteDescription(offer);
		pc.createAnswer(function(desc){
			console.log(desc);
			pc.setLocalDescription(desc, function(){
				inst.innerText = "Now send this to the other person and click continue.";
				area.value = JSON.stringify(pc.localDescription);
				button.onclick = answerSent;
			}, function(){});
		}, function(){});
	}
	
	navigator.webkitGetUserMedia({video: true, audio: true}, function(stream){
		vid1.src = URL.createObjectURL(stream);
		pc.addStream(stream);
		
		acceptOffer();
	}, function(){});
}

</script>
